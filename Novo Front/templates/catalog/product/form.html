<form id="productForm" class="grid grid-cols-1 md:grid-cols-3 gap-4">
  <!-- üè∑Ô∏è Nome -->
  <div class="md:col-span-2">
    <label class="block text-sm text-slate-300 mb-1 font-medium">Nome</label>
    <input name="name" placeholder="Ex: Pastilha de freio dianteira"
           class="w-full px-3 py-2 rounded-lg bg-slate-900/70 border border-slate-700 text-slate-100 focus:ring-2 focus:ring-emerald-500 outline-none"
           required />
  </div>

  <!-- üì¶ C√≥digo de barras -->
  <div>
    <label class="block text-sm text-slate-300 mb-1 font-medium">C√≥digo de barras</label>
    <input name="barcode" placeholder="EAN / GTIN"
           class="w-full px-3 py-2 rounded-lg bg-slate-900/70 border border-slate-700 text-slate-100 focus:ring-2 focus:ring-emerald-500 outline-none" />
  </div>

  <!-- üóÇÔ∏è Categoria -->
  <div>
    <label class="block text-sm text-slate-300 mb-1 font-medium">Categoria</label>
    <select name="category" id="category"
            class="w-full px-3 py-2 rounded-lg bg-slate-900/70 border border-slate-700 text-slate-100 focus:ring-2 focus:ring-emerald-500 outline-none">
    </select>
  </div>

  <!-- üè≠ Marca -->
  <div>
    <label class="block text-sm text-slate-300 mb-1 font-medium">Marca</label>
    <select name="brand" id="brand"
            class="w-full px-3 py-2 rounded-lg bg-slate-900/70 border border-slate-700 text-slate-100 focus:ring-2 focus:ring-emerald-500 outline-none">
    </select>
  </div>

  <!-- üí∞ Pre√ßo de custo -->
  <div>
    <label class="block text-sm text-slate-300 mb-1 font-medium">Pre√ßo de custo</label>
    <div class="relative">
      <span class="absolute left-3 top-2 text-slate-500">R$</span>
      <input name="cost_price" type="number" step="0.01" min="0"
             class="w-full pl-8 pr-3 py-2 rounded-lg bg-slate-900/70 border border-slate-700 text-slate-100 focus:ring-2 focus:ring-emerald-500 outline-none"
             required />
    </div>
  </div>

  <!-- üìà Margem -->
  <div>
    <label class="block text-sm text-slate-300 mb-1 font-medium">Margem (%)</label>
    <input name="margin" type="number" step="0.01" min="0" max="100" value="0"
           class="w-full px-3 py-2 rounded-lg bg-slate-900/70 border border-slate-700 text-slate-100 focus:ring-2 focus:ring-emerald-500 outline-none"
           required />
  </div>

  <!-- üìù Descri√ß√£o -->
  <div class="md:col-span-3">
    <label class="block text-sm text-slate-300 mb-1 font-medium">Descri√ß√£o</label>
    <textarea name="description" placeholder="Breve descri√ß√£o do produto..."
              class="w-full px-3 py-2 rounded-lg bg-slate-900/70 border border-slate-700 text-slate-100 focus:ring-2 focus:ring-emerald-500 outline-none resize-y" rows="2"></textarea>
  </div>

  <!-- üíæ Bot√£o -->
  <div class="md:col-span-3 flex justify-end">
    <button class="inline-flex items-center gap-2 bg-emerald-600 hover:bg-emerald-500 transition text-white text-sm font-medium rounded-lg px-4 py-2 shadow">
      <i data-lucide="save" class="w-4 h-4"></i>
      Salvar Produto
    </button>
  </div>
</form>

<script>
  // ‚öôÔ∏è Inicializa√ß√£o do formul√°rio
  (async function initForm(){
    try {
      const cats = await Http.fetchJson('/api/catalog/categories/?ordering=name');
      const catSel = document.getElementById('category');
      catSel.innerHTML = (cats.results||cats||[])
        .map(c=>`<option value="${c.uuid}">${c.name}</option>`).join('');
    } catch(e) {}

    try {
      const brands = await Http.fetchJson('/api/catalog/brands/?ordering=name');
      const brandSel = document.getElementById('brand');
      brandSel.innerHTML = (brands.results||brands||[])
        .map(b=>`<option value="${b.uuid}">${b.name}</option>`).join('');
    } catch(e) {}
  })();

  // üíæ Submiss√£o do formul√°rio
  document.getElementById('productForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const form = e.currentTarget || e.target;
    const submitBtn = form.querySelector('button[type="submit"], button');
    FormUtils.clearFieldErrors(form);
    FormUtils.setLoading(submitBtn, true);
    const fd = new FormData(form);
    const payload = {
      name: fd.get('name'),
      // send empty string instead of null to avoid serializer rejecting null
      barcode: fd.get('barcode') || '',
      category: fd.get('category') || '',
      brand: fd.get('brand') || '',
      cost_price: fd.get('cost_price'),
      margin: fd.get('margin') || 0,
      description: fd.get('description') || '',
      active: true,
    };

    try {
      await Http.fetchJson('/api/catalog/products/', { method: 'POST', body: JSON.stringify(payload) });
      Http.toast('Produto criado com sucesso!', 'success');
      if (form && typeof form.reset === 'function') form.reset();
      if (typeof load === 'function') load();
      const newWrap = document.getElementById('newProductWrap') || document.getElementById('product-new-wrap');
      if(newWrap) newWrap.classList.add('hidden');
      if(typeof closeProductForm === 'function') closeProductForm();
    } catch(err){
      // if backend returned validation errors (err.data), show them next to fields
      if(err && err.data){
        FormUtils.showFieldErrors(form, err.data);
      } else {
        Http.toast(err.message || 'Erro ao salvar produto', 'error');
      }
    } finally {
      FormUtils.setLoading(submitBtn, false);
    }
  });
</script>
