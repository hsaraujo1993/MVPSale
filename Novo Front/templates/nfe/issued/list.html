<div class="flex flex-wrap items-center gap-2 bg-slate-800/40 border border-slate-700/60 rounded-xl p-3 mb-4 backdrop-blur-sm">
  <label for="q" class="sr-only">Buscar</label>
  <input id="q" placeholder="Buscar por referência ou chave..." class="flex-1 min-w-[220px] px-3 py-2 rounded bg-slate-900 border border-slate-700 text-sm focus:ring-2 focus:ring-emerald-500 outline-none" />
  <label for="status" class="sr-only">Status</label>
  <select id="status" class="px-3 py-2 rounded bg-slate-900 border border-slate-700 text-sm focus:ring-2 focus:ring-emerald-500 outline-none">
    <option value="">Todos</option>
    <option value="SUBMITTED">Enviada</option>
    <option value="AUTHORIZED">Autorizada</option>
    <option value="REJECTED">Rejeitada</option>
    <option value="CANCELED">Cancelada</option>
  </select>
  <label for="ordering" class="sr-only">Ordenação</label>
  <select id="ordering" class="px-3 py-2 rounded bg-slate-900 border border-slate-700 text-sm focus:ring-2 focus:ring-emerald-500 outline-none">
    <option value="-created_at">Mais recentes</option>
    <option value="created_at">Mais antigas</option>
  </select>
  <button id="apply" class="flex items-center gap-1 px-3 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded transition text-sm">Aplicar</button>
  <button id="refreshAll" class="flex items-center gap-1 px-3 py-2 bg-slate-800 hover:bg-slate-700 text-slate-200 border border-slate-700 rounded transition text-sm">Atualizar Todos</button>

  <div id="chips" class="flex items-center gap-2 text-sm ml-auto">
    <button data-status="" class="chip px-3 py-1.5 rounded bg-slate-900 text-slate-300 border border-slate-700">Todos</button>
    <button data-status="AUTHORIZED" class="chip px-3 py-1.5 rounded bg-slate-900 text-slate-300 border border-slate-700">Autorizada</button>
    <button data-status="SUBMITTED" class="chip px-3 py-1.5 rounded bg-slate-900 text-slate-300 border border-slate-700">Enviada</button>
    <button data-status="REJECTED" class="chip px-3 py-1.5 rounded bg-slate-900 text-slate-300 border border-slate-700">Rejeitada</button>
  </div>
</div>

<div class="overflow-x-auto border border-slate-700 rounded-xl shadow-sm">
  <table class="min-w-full text-sm border-separate border-spacing-0">
    <thead class="bg-slate-800/70 text-slate-300 uppercase text-xs">
      <tr>
        <th class="text-left px-3 py-2 font-medium">Ref</th>
        <th class="text-left px-3 py-2 font-medium">Pedido</th>
        <th class="text-left px-3 py-2 font-medium">Status</th>
        <th class="text-left px-3 py-2 font-medium">Chave</th>
        <th class="text-left px-3 py-2 font-medium">Total</th>
        <th class="text-left px-3 py-2 font-medium">Criada em</th>
        <th class="text-left px-3 py-2 font-medium">Ações</th>
      </tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>
</div>

<div class="mt-4 flex items-center gap-2 text-sm">
  <button id="prev" class="px-3 py-1.5 rounded-lg bg-slate-800 hover:bg-slate-700 border border-slate-700 transition flex items-center gap-1">Anterior</button>
  <span id="pageInfo" class="text-slate-400 min-w-[80px] text-center"></span>
  <button id="next" class="px-3 py-1.5 rounded-lg bg-slate-800 hover:bg-slate-700 border border-slate-700 transition flex items-center gap-1">Próxima</button>
</div>

<script>
(() => {
  const state = { page: 1, q: '', status: '', ordering: '-created_at', next: null, previous: null };
  const rows = document.getElementById('rows');
  const q = document.getElementById('q');
  const status = document.getElementById('status');
  const ordering = document.getElementById('ordering');
  const apply = document.getElementById('apply');
  const prev = document.getElementById('prev');
  const next = document.getElementById('next');
  const pageInfo = document.getElementById('pageInfo');
  const chips = document.getElementById('chips');

  function pad2(n){ return String(n).padStart(2,'0'); }
  function fmtDateTime(s){ try { const d=new Date(s); if(isNaN(d.getTime())) return '-'; return `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`; } catch(e){ return '-'; } }
  function money(v){ try { const n=parseFloat(v||0); return 'R$ '+n.toFixed(2); } catch(e){ return 'R$ 0,00'; } }
  function statusBadge(st){ const x=String(st||'').toUpperCase(); const map = { AUTHORIZED: ['bg-emerald-700 text-white','Autorizada'], SUBMITTED: ['bg-slate-600 text-white','Enviada'], REJECTED: ['bg-rose-700 text-white','Rejeitada'], CANCELED: ['bg-amber-600 text-black','Cancelada'] }; const [cls,txt]=(map[x]||['bg-slate-700 text-slate-200',x]); return `<span class="inline-block px-2 py-0.5 rounded-full ${cls}">${txt}</span>`; }

  async function load(){
    const params = new URLSearchParams();
    params.set('page', state.page);
    if ((q.value||'').trim()) params.set('search', q.value.trim());
    if ((status.value||'').trim()) params.set('status', status.value);
    if ((ordering.value||'').trim()) params.set('ordering', ordering.value);
    const data = await Http.fetchJson(`/api/nfe/invoices/?${params.toString()}`);
    const results = data && (data.results||data) || [];
    rows.innerHTML = '';
    results.forEach(inv => {
      const tr = document.createElement('tr');
      tr.className = 'border-b border-slate-800 hover:bg-slate-800/40';
      try{ tr.dataset.id = inv.uuid; }catch(e){}
      const ref = inv.ref || '-';
      const chave = inv.chave || '-';
      const total = money(inv.total);
      const orderLink = inv.order_uuid ? `<a href="/orders/confirm?id=${inv.order_uuid}" class="text-sky-400 hover:underline">Ver pedido</a>` : (inv.order||'-');
      tr.innerHTML = `
        <td class="px-3 py-2">${ref}</td>
        <td class="px-3 py-2 text-slate-400">${orderLink}</td>
        <td class="px-3 py-2">${statusBadge(inv.status)}</td>
        <td class="px-3 py-2 text-slate-300">${chave}</td>
        <td class="px-3 py-2">${total}</td>
        <td class="px-3 py-2">${fmtDateTime(inv.created_at)}</td>
        <td class="px-3 py-2 space-x-3">
          <button data-refresh="${inv.uuid}" class="text-sky-400 hover:underline">Atualizar</button>
          <a href="/api/nfe/invoices/${inv.uuid}/danfe/" target="_blank" class="text-sky-400 hover:underline">DANFE</a>
          <a href="/api/nfe/invoices/${inv.uuid}/xml/" class="text-sky-400 hover:underline">XML</a>
        </td>`;
      rows.appendChild(tr);
    });
    state.next = data.next || null; state.previous = data.previous || null; pageInfo.textContent = `Página ${state.page}`;
  }

  chips.addEventListener('click', (e)=>{ const btn = e.target.closest('button'); if(!btn) return; const st = btn.getAttribute('data-status')||''; status.value = st; state.page=1; load(); });
  apply.addEventListener('click', ()=> load());
  prev.addEventListener('click', ()=>{ if (state.previous){ state.page--; load(); }});
  next.addEventListener('click', ()=>{ if (state.next){ state.page++; load(); }});

  document.getElementById('refreshAll')?.addEventListener('click', async ()=>{
    try{
      const btn = document.getElementById('refreshAll');
      btn.disabled = true; btn.textContent = 'Atualizando...';
      const ids = Array.from(document.querySelectorAll('#rows tr[data-id]')).map(tr=>tr.dataset.id).filter(Boolean);
      for (let i=0; i<ids.length; i++){
        const id = ids[i];
        btn.textContent = `Atualizando ${i+1}/${ids.length}...`;
        try { await Http.fetchJson(`/api/nfe/invoices/${id}/refresh/`, { method:'POST' }); }
        catch(e){ /* continua */ }
      }
      Http.toast('Notas atualizadas', 'success');
      load();
    } finally {
      const btn = document.getElementById('refreshAll');
      if (btn){ btn.disabled=false; btn.textContent='Atualizar Todos'; }
    }
  });

  rows.addEventListener('click', async (e)=>{
    const btn = e.target.closest('button[data-refresh]');
    if (!btn) return;
    const id = btn.getAttribute('data-refresh');
    try {
      btn.disabled = true; btn.textContent = 'Atualizando...';
      await Http.fetchJson(`/api/nfe/invoices/${id}/refresh/`, { method: 'POST' });
      Http.toast('Status atualizado', 'success');
      load();
    } catch(err){ Http.toast(err?.message||'Falha ao atualizar', 'error'); }
    finally { btn.disabled = false; btn.textContent = 'Atualizar'; }
  });

  load();
})();
</script>
