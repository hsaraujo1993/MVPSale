{% extends "base.html" %}
{% block title %}Pedidos - MVPSale{% endblock %}
{% block content %}
{% include "partials/breadcrumb.html" with b1="Pedidos" %}
<h1 class="text-2xl font-semibold mb-4">Listagem de Pedidos</h1>

<div class="flex flex-wrap items-center gap-2 bg-slate-800/40 border border-slate-700/60 rounded-xl p-3 mb-4 backdrop-blur-sm">
  <label for="q" class="sr-only">Buscar pedidos</label>
  <input id="q" placeholder="Buscar pedidos..." class="flex-1 min-w-[200px] px-3 py-2 rounded bg-slate-900 border border-slate-700 text-sm focus:ring-2 focus:ring-emerald-500 outline-none" />

  <label for="status" class="sr-only">Status</label>
  <select id="status" class="px-3 py-2 rounded bg-slate-900 border border-slate-700 text-sm focus:ring-2 focus:ring-emerald-500 outline-none">
    <option value="">Todos</option>
    <option value="DRAFT">Rascunho</option>
    <option value="CONFIRMED">Confirmado</option>
    <option value="CANCELLED">Cancelado</option>
  </select>

  <label for="ordering" class="sr-only">Ordenação</label>
  <select id="ordering" class="px-3 py-2 rounded bg-slate-900 border border-slate-700 text-sm focus:ring-2 focus:ring-emerald-500 outline-none">
    <option value="-created_at">Mais recentes</option>
    <option value="total">Total</option>
  </select>

  <button id="applyFilters" class="flex items-center gap-1 px-3 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded transition text-sm">Aplicar</button>

  <label class="flex items-center gap-2 text-sm text-slate-300 ml-auto">
    <input type="checkbox" id="onlyConfirmed" class="accent-emerald-600" /> Somente confirmados
  </label>

  <div id="statusChips" class="flex items-center gap-2 text-sm">
    <button data-status="" class="chip px-3 py-1.5 rounded bg-slate-900 text-slate-300 border border-slate-700">Todos</button>
    <button data-status="DRAFT" class="chip px-3 py-1.5 rounded bg-slate-900 text-slate-300 border border-slate-700">Rascunho</button>
    <button data-status="CONFIRMED" class="chip px-3 py-1.5 rounded bg-slate-900 text-slate-300 border border-slate-700">Confirmado</button>
    <button data-status="CANCELLED" class="chip px-3 py-1.5 rounded bg-slate-900 text-slate-300 border border-slate-700">Cancelado</button>
  </div>
</div>

<div class="overflow-x-auto border border-slate-700 rounded-xl shadow-sm">
  <table class="min-w-full text-sm border-separate border-spacing-0">
    <thead class="bg-slate-800/70 text-slate-300 uppercase text-xs">
      <tr>
        <th class="text-left px-3 py-2 font-medium">Pedido</th>
        <th class="text-left px-3 py-2 font-medium">Tipo</th>
        <th class="text-left px-3 py-2 font-medium">Status</th>
        <th class="text-left px-3 py-2 font-medium">Total</th>
        <th class="text-left px-3 py-2 font-medium">Criado em</th>
        <th class="text-left px-3 py-2 font-medium">Ações</th>
      </tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>
</div>

<div class="mt-4 flex items-center gap-2 text-sm">
  <button id="prev" class="px-3 py-1.5 rounded-lg bg-slate-800 hover:bg-slate-700 border border-slate-700 transition flex items-center gap-1"><i data-lucide="chevron-left" class="w-4 h-4"></i> Anterior</button>
  <span id="pageInfo" class="text-slate-400 min-w-[80px] text-center"></span>
  <button id="next" class="px-3 py-1.5 rounded-lg bg-slate-800 hover:bg-slate-700 border border-slate-700 transition flex items-center gap-1">Próxima <i data-lucide="chevron-right" class="w-4 h-4"></i></button>
</div>

<script>
  (function(){
    const s = { page:1, q:'', status:'', ordering:'-created_at', next:null, previous:null };
    const rows = document.getElementById('rows');
    const q = document.getElementById('q');
    const status = document.getElementById('status');
    const ordering = document.getElementById('ordering');
    const apply = document.getElementById('applyFilters');
    const prev = document.getElementById('prev');
    const next = document.getElementById('next');
    const pageInfo = document.getElementById('pageInfo');
    const only = document.getElementById('onlyConfirmed');

    // Garante coluna "Tipo" no cabeçalho (segunda posição)
    try {
      const theadRow = document.querySelector('table thead tr');
      if (theadRow && (!Array.from(theadRow.children).some(th => (th.textContent||'').trim() === 'Tipo'))) {
        const th = document.createElement('th');
        th.className = 'text-left px-3 py-2 font-medium';
        th.textContent = 'Tipo';
        if (theadRow.children.length > 1) {
          theadRow.insertBefore(th, theadRow.children[1]);
        } else {
          theadRow.appendChild(th);
        }
      }
    } catch(e) {}

    function fmtMoney(v){ try { return 'R$ ' + (parseFloat(v)||0).toFixed(2); } catch(e){ return 'R$ 0,00'; } }
    function pad2(n){ return String(n).padStart(2,'0'); }
    function fmtDateTime(s){
      try { const d = new Date(s); if (isNaN(d.getTime())) return String(s||''); const dd = pad2(d.getDate()), mm = pad2(d.getMonth()+1), yy = d.getFullYear(); const hh = pad2(d.getHours()), mi = pad2(d.getMinutes()); return `${dd}/${mm}/${yy} ${hh}:${mi}`; } catch(e){ return String(s||''); }
    }
    function statusBadge(st){ const x = String(st||'').toUpperCase(); let cls='bg-slate-700 text-slate-200', txt=x; if(x==='CONFIRMED'){cls='bg-emerald-700 text-white'; txt='Confirmado';} else if(x==='DRAFT'){cls='bg-slate-600 text-white'; txt='Rascunho';} else if(x==='CANCELLED'){cls='bg-rose-700 text-white'; txt='Cancelado';} return `<span class="inline-block px-2 py-0.5 rounded-full ${cls}">${txt}</span>`; }

    async function load(){
      const params = new URLSearchParams();
      params.set('page', String(s.page));
      if ((q.value||'').trim().length) params.set('search', q.value.trim());
      if ((status.value||'').trim().length) params.set('status', status.value);
      if ((ordering.value||'').trim().length) params.set('ordering', ordering.value);
      const data = await Http.fetchJson(`/api/sale/orders/?${params.toString()}`);
      const results = data && (data.results||data) || [];
      rows.innerHTML = '';
      results.forEach(o => {
        const tr = document.createElement('tr');
        tr.className = 'border-b border-slate-800 hover:bg-slate-800/40';
        tr.dataset.uuid = o.uuid || '';
        tr.dataset.status = String(o.status||'').toUpperCase();

        const so = (o.sales_order && String(o.sales_order).length) ? o.sales_order : '-';
        const typ = (String(o.order_type||'carrinho').toLowerCase()==='orcamento') ? 'Orçamento' : 'Pedido';
        const typeBadge = `<span class="ml-2 inline-block px-2 py-0.5 rounded-full text-xs ${typ==='Orçamento' ? 'bg-amber-700 text-white' : 'bg-slate-700 text-slate-200'}">${typ}</span>`;
        const tdPedido = document.createElement('td'); tdPedido.className='px-3 py-2'; tdPedido.textContent = `${so}`; tr.appendChild(tdPedido); const tdTipo = document.createElement('td'); tdTipo.className='px-3 py-2'; tdTipo.innerHTML = typeBadge; tr.appendChild(tdTipo);
        const tdStatus = document.createElement('td'); tdStatus.className='px-3 py-2'; tdStatus.innerHTML = statusBadge(o.status); tr.appendChild(tdStatus);
        const tdTotal = document.createElement('td'); tdTotal.className='px-3 py-2'; tdTotal.textContent = fmtMoney(o.total||0); tr.appendChild(tdTotal);
        const tdCreated = document.createElement('td'); tdCreated.className='px-3 py-2'; tdCreated.textContent = fmtDateTime(o.created_at); tr.appendChild(tdCreated);

        const tdActions = document.createElement('td'); tdActions.className='px-3 py-2 flex flex-wrap gap-2';
        const view = document.createElement('a'); view.href = `/orders/confirm?id=${o.uuid}`; view.className='text-sky-400 hover:underline'; view.textContent='Visualizar'; tdActions.appendChild(view);
        tr.appendChild(tdActions);
        rows.appendChild(tr);
      });
      s.next = data.next || null; s.previous = data.previous || null; pageInfo.textContent = `Página ${s.page}`;
    }

    const chips = document.getElementById('statusChips');
    chips.addEventListener('click', (e)=>{
      const btn = e.target.closest('button'); if(!btn) return; const st = btn.getAttribute('data-status')||''; status.value = st; s.page=1; load();
    });
    apply.addEventListener('click', ()=> load());
    if (only) only.addEventListener('change', ()=>{ if (only.checked) { status.value = 'CONFIRMED'; status.setAttribute('disabled','disabled'); } else { status.removeAttribute('disabled'); if (status.value==='CONFIRMED') status.value=''; } s.page=1; load(); });

    load();
  })();
</script>
{% endblock %}
