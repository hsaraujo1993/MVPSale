<!-- üè∑Ô∏è Cabe√ßalho -->
<div class="flex items-center justify-between mb-6">
  <div>
    <h1 class="text-2xl font-semibold tracking-tight">Clientes</h1>
    <p class="text-slate-400 text-sm">Gerencie clientes e informa√ß√µes de contato.</p>
  </div>
  <a href="#" id="toggleNewCust" class="inline-flex items-center gap-2 bg-emerald-600 hover:bg-emerald-500 text-white text-sm font-medium px-4 py-2 rounded-lg shadow-sm transition">Novo Cliente</a>
</div>

<div id="newCustWrap" class="hidden mb-4 bg-slate-800/50 border border-slate-700 rounded-2xl p-4">
  <form id="newCustForm" class="grid grid-cols-1 md:grid-cols-3 gap-2 items-end">
    <div class="md:col-span-3">
      <label for="cust-name" class="sr-only">Nome</label>
      <label for="cust-name" class="block text-sm mb-1">Nome</label>
      <input id="cust-name" name="name" class="w-full px-3 py-2 rounded bg-slate-900 border border-slate-700" required />
    </div>
    <div>
      <label for="cust-cpf" class="sr-only">CPF/CNPJ</label>
      <label for="cust-cpf" class="block text-sm mb-1">CPF/CNPJ</label>
      <input id="cust-cpf" name="cpf_cnpj" class="w-full px-3 py-2 rounded bg-slate-900 border border-slate-700" />
    </div>
    <div>
      <label for="cust-email" class="sr-only">Email</label>
      <label for="cust-email" class="block text-sm mb-1">Email</label>
      <input id="cust-email" name="email" type="email" class="w-full px-3 py-2 rounded bg-slate-900 border border-slate-700" />
    </div>
    <div>
      <label for="cust-phone" class="sr-only">Telefone</label>
      <label for="cust-phone" class="block text-sm mb-1">Telefone</label>
      <input id="cust-phone" name="phone" class="w-full px-3 py-2 rounded bg-slate-900 border border-slate-700" />
    </div>
    <div>
      <label for="cust-cep" class="sr-only">CEP</label>
      <label for="cust-cep" class="block text-sm mb-1">CEP</label>
      <div class="flex items-center gap-2">
        <input id="cust-cep" name="cep" class="w-full px-3 py-2 rounded bg-slate-900 border border-slate-700" />
        <button id="cust-cep-lookup" type="button" class="px-3 py-2 bg-sky-600 hover:bg-sky-500 text-white rounded">Buscar CEP</button>
      </div>
    </div>
    <div>
      <label for="cust-address" class="sr-only">Endere√ßo</label>
      <label for="cust-address" class="block text-sm mb-1">Endere√ßo</label>
      <input id="cust-address" name="address" class="w-full px-3 py-2 rounded bg-slate-900 border border-slate-700" />
    </div>
    <div>
      <label for="cust-city" class="sr-only">Cidade</label>
      <label for="cust-city" class="block text-sm mb-1">Cidade</label>
      <input id="cust-city" name="city" class="w-full px-3 py-2 rounded bg-slate-900 border border-slate-700" />
    </div>
    <div>
      <label for="cust-uf" class="sr-only">UF</label>
      <label for="cust-uf" class="block text-sm mb-1">UF</label>
      <input id="cust-uf" name="uf" class="w-full px-3 py-2 rounded bg-slate-900 border border-slate-700" />
    </div>
    <div class="md:col-span-3">
      <button class="bg-emerald-600 hover:bg-emerald-500 transition text-white rounded px-3 py-2">Salvar</button>
    </div>
  </form>
  <hr class="my-3 border-slate-700" />
</div>

<div class="mb-3 flex items-center justify-between">
  <div class="flex flex-wrap gap-2 items-center bg-slate-800/40 border border-slate-700/60 rounded-xl p-3 backdrop-blur-sm">
    <label for="qCust" class="sr-only">Buscar clientes</label>
    <input id="qCust" aria-label="Buscar clientes" placeholder="Buscar por nome/email/telefone" class="px-3 py-2 rounded bg-slate-900 border border-slate-700 min-w-[260px] text-sm" />
    <label for="orderingCust" class="sr-only">Ordena√ß√£o</label>
    <select id="orderingCust" aria-label="Ordena√ß√£o" class="px-3 py-2 rounded bg-slate-900 border border-slate-700 text-sm">
      <option value="name">Nome</option>
      <option value="-created_at">Mais recentes</option>
    </select>
    <button id="applyCust" class="flex items-center gap-1 px-3 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded transition text-sm">Aplicar</button>
  </div>
</div>

<div class="overflow-x-auto border border-slate-700 rounded-xl shadow-sm">
  <table class="min-w-full text-sm border-separate border-spacing-0">
    <thead class="bg-slate-800/70 text-slate-300 uppercase text-xs"><tr>
      <th class="text-left px-3 py-2 font-medium">Nome</th>
      <th class="text-left px-3 py-2 font-medium">CPF/CNPJ</th>
      <th class="text-left px-3 py-2 font-medium">Email</th>
      <th class="text-left px-3 py-2 font-medium">Telefone</th>
      <th class="text-left px-3 py-2 font-medium">A√ß√µes</th>
    </tr></thead>
    <tbody id="rowsCust" class="[&_tr:nth-child(even)]:bg-slate-800/40 [&_tr:hover]:bg-slate-700/40 transition"></tbody>
  </table>
</div>

<div class="mt-4 flex items-center gap-2 text-sm">
  <button id="prevCust" class="px-3 py-1.5 rounded-lg bg-slate-800 hover:bg-slate-700 border border-slate-700 transition">‚Üê Anterior</button>
  <span id="pageInfoCust" class="text-slate-400 min-w-[80px] text-center"></span>
  <button id="nextCust" class="px-3 py-1.5 rounded-lg bg-slate-800 hover:bg-slate-700 border border-slate-700 transition">Pr√≥xima ‚Üí</button>
</div>

<script>
  const scu = { page:1, q:'', ordering:'name', next:null, previous:null };
  const rows = document.getElementById('rowsCust');
  const q = document.getElementById('qCust');
  const ordering = document.getElementById('orderingCust');
  const apply = document.getElementById('applyCust');
  const prev = document.getElementById('prevCust');
  const next = document.getElementById('nextCust');
  const pageInfo = document.getElementById('pageInfoCust');
  const toggleNewCust = document.getElementById('toggleNewCust');
  const newCustWrap = document.getElementById('newCustWrap');
  toggleNewCust.addEventListener('click', (e)=>{ e.preventDefault(); newCustWrap.classList.toggle('hidden'); });
  document.getElementById('newCustForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const form = e.currentTarget || e.target;
    const submitBtn = form.querySelector('button[type="submit"], button');
    FormUtils.clearFieldErrors(form);
    FormUtils.setLoading(submitBtn, true);
    const fd = new FormData(form);
    const payload = { name: fd.get('name'), cpf_cnpj: fd.get('cpf_cnpj'), email: fd.get('email'), phone: fd.get('phone'), address: fd.get('address'), cep: fd.get('cep'), city: fd.get('city'), uf: fd.get('uf') };
    try{
      await Http.fetchJson('/api/people/customers/', { method:'POST', body: JSON.stringify(payload) });
      Http.toast('Cliente criado','success');
      if (form && typeof form.reset === 'function') form.reset();
      newCustWrap.classList.add('hidden');
      load();
    }
    catch(err){
      if(err && err.data){ FormUtils.showFieldErrors(form, err.data); }
      else Http.toast(err.message||'Erro ao criar cliente','error');
    } finally { FormUtils.setLoading(submitBtn, false); }
  });
  apply.addEventListener('click', ()=>{ scu.page=1; scu.q=q.value; scu.ordering=ordering.value; load(); });
  prev.addEventListener('click', ()=>{ if(scu.previous){ scu.page--; load(); }});
  next.addEventListener('click', ()=>{ if(scu.next){ scu.page++; load(); }});

  async function load(){
    const params = new URLSearchParams(); params.set('page', scu.page);
    if(scu.q) params.set('search', scu.q); if(scu.ordering) params.set('ordering', scu.ordering);
    try{
      const data = await Http.fetchJson(`/api/people/customers/?${params}`);
      rows.innerHTML=''; (data.results||[]).forEach(c=>{
        const tr = document.createElement('tr'); tr.innerHTML = `
          <td class="px-3 py-2">${c.name}</td>
          <td class="px-3 py-2">${c.cpf_cnpj||''}</td>
          <td class="px-3 py-2">${c.email||''}</td>
          <td class="px-3 py-2">${c.phone||''}</td>
          <td class="px-3 py-2"><button class="text-sky-400 hover:underline" data-view="${c.uuid}">Visualizar</button></td>`; rows.appendChild(tr);
      }); rows.querySelectorAll('[data-view]').forEach(btn=> btn.addEventListener('click', ()=> viewCust(btn.dataset.view)));
      scu.next=data.next; scu.previous=data.previous; pageInfo.textContent = `P√°gina ${scu.page}`;
    }catch(err){ Http.toast(err.message||'Erro ao carregar clientes','error'); }
  } load();

  const detailWrap = document.createElement('div'); detailWrap.className='mt-4'; rows.parentElement.parentElement.after(detailWrap);
  async function viewCust(uuid){
    try{
      const c = await Http.fetchJson(`/api/people/customers/${uuid}/`);
      detailWrap.innerHTML = `
        <div class="bg-slate-800/50 border border-slate-700 rounded-xl p-4">
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-medium">Detalhe do Cliente</h3>
            <div class="space-x-2">
              <button id="editCust" class="px-3 py-1 rounded bg-slate-700">Editar</button>
              <button id="delCust" class="px-3 py-1 rounded bg-rose-600 text-white">Deletar</button>
              <button id="closeCust" class="px-3 py-1 rounded bg-slate-700">Voltar</button>
            </div>
          </div>
          <div id="custView" class="space-y-1">
            <div class="text-sm">Nome: <span>${c.name}</span></div>
            <div class="text-sm">CPF/CNPJ: <span>${c.cpf_cnpj||''}</span></div>
            <div class="text-sm">Email: <span>${c.email||''}</span></div>
            <div class="text-sm">Telefone: <span>${c.phone||''}</span></div>
            <div class="text-sm">Cidade/UF: <span>${c.city||''}/${c.uf||''}</span></div>
          </div>
          <form id="custEdit" class="hidden grid grid-cols-1 md:grid-cols-3 gap-2 mt-2">
            <div><label for="cust-edit-name" class="block text-sm mb-1">Nome</label><input id="cust-edit-name" name="name" value="${c.name}" class="px-3 py-2 rounded bg-slate-900 border border-slate-700"/></div>
            <div><label for="cust-edit-cpf" class="block text-sm mb-1">CPF/CNPJ</label><input id="cust-edit-cpf" name="cpf_cnpj" value="${c.cpf_cnpj||''}" class="px-3 py-2 rounded bg-slate-900 border border-slate-700"/></div>
            <div><label for="cust-edit-email" class="block text-sm mb-1">Email</label><input id="cust-edit-email" name="email" value="${c.email||''}" class="px-3 py-2 rounded bg-slate-900 border border-slate-700"/></div>
            <div><label for="cust-edit-phone" class="block text-sm mb-1">Telefone</label><input id="cust-edit-phone" name="phone" value="${c.phone||''}" class="px-3 py-2 rounded bg-slate-900 border border-slate-700"/></div>
            <div><label for="cust-edit-cep" class="block text-sm mb-1">CEP</label><div class="flex items-center gap-2"><input id="cust-edit-cep" name="cep" value="${c.cep||''}" class="px-3 py-2 rounded bg-slate-900 border border-slate-700"/><button id="cust-edit-cep-lookup" type="button" class="px-3 py-2 bg-sky-600 hover:bg-sky-500 text-white rounded">Buscar CEP</button></div></div>
            <div><label for="cust-edit-address" class="block text-sm mb-1">Endere√ßo</label><input id="cust-edit-address" name="address" value="${c.address||''}" class="px-3 py-2 rounded bg-slate-900 border border-slate-700"/></div>
            <div><label for="cust-edit-city" class="block text-sm mb-1">Cidade</label><input id="cust-edit-city" name="city" value="${c.city||''}" class="px-3 py-2 rounded bg-slate-900 border border-slate-700"/></div>
            <div><label for="cust-edit-uf" class="block text-sm mb-1">UF</label><input id="cust-edit-uf" name="uf" value="${c.uf||''}" class="px-3 py-2 rounded bg-slate-900 border border-slate-700"/></div>
            <div class="md:col-span-3"><button class="bg-emerald-600 hover:bg-emerald-500 transition text-white rounded px-3 py-2">Salvar</button></div>
          </form>
        </div>`;
      detailWrap.scrollIntoView({behavior:'smooth'});
      document.getElementById('closeCust').onclick = ()=> detailWrap.innerHTML='';
      document.getElementById('editCust').onclick = ()=>{ document.getElementById('custView').classList.add('hidden'); document.getElementById('custEdit').classList.remove('hidden'); };
      document.getElementById('delCust').onclick = ()=> UI.confirm(`Excluir cliente "${c.name}"?`, async ()=>{ try{ await Http.fetchJson(`/api/people/customers/${uuid}/`, { method:'DELETE' }); Http.toast('Exclu√≠do','success'); detailWrap.innerHTML=''; load(); }catch(err){ Http.toast(err.message||'Erro ao excluir','error'); } }, 'Excluir', 'danger');
      document.getElementById('custEdit').onsubmit = async (e)=>{
        e.preventDefault();
        const form = e.currentTarget || e.target;
        const submitBtn = form.querySelector('button[type="submit"], button');
        FormUtils.clearFieldErrors(form);
        FormUtils.setLoading(submitBtn, true);
        const fd=new FormData(form);
        const payload={ name:fd.get('name'), cpf_cnpj:fd.get('cpf_cnpj'), email:fd.get('email'), phone:fd.get('phone'), address:fd.get('address'), cep:fd.get('cep'), city:fd.get('city'), uf:fd.get('uf') };
        try{ await Http.fetchJson(`/api/people/customers/${uuid}/`, { method:'PATCH', body: JSON.stringify(payload)}); Http.toast('Atualizado','success'); viewCust(uuid); }
        catch(err){ if(err && err.data) FormUtils.showFieldErrors(form, err.data); else Http.toast(err.message||'Erro ao atualizar','error'); }
        finally{ FormUtils.setLoading(submitBtn, false); }
      };
    }catch(err){ Http.toast(err.message||'Erro ao carregar detalhe','error'); }
  }

  // add cep lookup helper and handlers
  async function lookupCepAndFill(cep, targetPrefix='cust'){
    if(!cep) { Http.toast('Informe o CEP','warn'); return; }
    try{
      const data = await Http.fetchJson(`/api/people/customers/cep/?cep=${encodeURIComponent(cep)}`);
      if(!data) { Http.toast('CEP n√£o encontrado','error'); return; }
      // fields: address, neighborhood, city, uf, cep
      const addrEl = document.getElementById(`${targetPrefix}-address`);
      const cityEl = document.getElementById(`${targetPrefix}-city`);
      const ufEl = document.getElementById(`${targetPrefix}-uf`);
      const cepEl = document.getElementById(`${targetPrefix}-cep`);
      const neighborhoodEl = document.getElementById(`${targetPrefix}-neighborhood`);
      if(cepEl) cepEl.value = data.cep || cep;
      if(addrEl) addrEl.value = data.address || '';
      if(cityEl) cityEl.value = data.city || '';
      if(ufEl) ufEl.value = data.uf || '';
      if(neighborhoodEl) neighborhoodEl.value = data.neighborhood || '';
      Http.toast('Endere√ßo preenchido pelo CEP','success');
    }catch(err){ Http.toast(err.message||'Erro ao buscar CEP','error'); }
  }

  // attach handler for new-customer CEP button
  document.getElementById('cust-cep-lookup')?.addEventListener('click', ()=>{
    const cepVal = document.getElementById('cust-cep')?.value || '';
    lookupCepAndFill(cepVal,'cust');
  });

  // attach handler for edit CEP button inside dynamic detail panel
  function attachEditCepHandler(){
    const btn = document.getElementById('cust-edit-cep-lookup');
    if(btn){
      btn.addEventListener('click', ()=>{
        const cepVal = document.getElementById('cust-edit-cep')?.value || '';
        lookupCepAndFill(cepVal,'cust-edit');
      });
    }
  }

  // ensure handler attached after dynamic detail is rendered
  const originalViewCust = viewCust;
  viewCust = async function(uuid){
    await originalViewCust(uuid);
    attachEditCepHandler();
  }
</script>
